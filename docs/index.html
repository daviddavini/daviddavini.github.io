<STYLE>
  div {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    height: 45vh;
  }
  div > div {
    margin: 2%;
  }
</STYLE>

<DIV>
  <DIV>
    <CANVAS id="caffeine"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="books"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="exercise"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="sleep"></CANVAS>
  </DIV>
</DIV>

<SCRIPT src="https://cdn.jsdelivr.net/npm/chart.js"></SCRIPT>
<SCRIPT src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></SCRIPT>

<SCRIPT SRC="data.js"></SCRIPT>
<SCRIPT>
  const origin = Date.parse('2023-08-19');
  const ONE_DAY = 86400000;
  const today = (new Date()).getTime();
  let x = origin;
  let full_data = [];
  data.forEach(row => {
    t = Date.parse(row.day);
    while (x < t) {
      full_data.push({day: (new Date(x)).toLocaleDateString()});
      x += ONE_DAY;
    }
    full_data.push(row);
    x += ONE_DAY;
  });
  while (x+ONE_DAY < today) {
    full_data.push({day: (new Date(x)).toLocaleDateString()});
    x += ONE_DAY;
  }
  data = full_data;

  data.forEach(row => {
    if (!("caffeine" in row)) {
      row.caffeine = []
    }
    if (!("reading" in row)) {
      row.reading = []
    }
    if (!("exercise" in row)) {
      row.exercise = []
    }
    if (!("sleep" in row)) {
      row.sleep = []
    }
  });

  data.forEach(row => row.sleep.forEach(x => {
    let [sh, sm] = x.start.split(':');
    let [eh, em] = x.end.split(':');
    x.duration = ((+eh)*60+(+em) - (+sh)*60+(+sm)) / 60;
    x.duration = x.duration>0 ? x.duration : x.duration+24;
  }))

  new Chart(
    document.getElementById('caffeine'),
    {
      type: 'bar',
      options: {
        maintainAspectRatio: false,
        plugins: {
          annotation: {
            annotations: {
              line: {
                type: 'line',
                yMin: 30,
                yMax: 30,
              }
            }
          }
        }
      },
      data: {
        labels: data.map(row => row.day),
        datasets: [
          {
            label: 'Caffeine consumption (in mg\'s)',
            data: data.map(row => row.caffeine.reduce((a, b) => a + b.amount, 0))
          }
        ]
      }
    }
  );
  new Chart(
    document.getElementById('books'),
    {
      type: 'bar',
      options: {
        maintainAspectRatio: false,
        plugins: {
          annotation: {
            annotations: {
              line: {
                type: 'line',
                yMin: 100,
                yMax: 100,
              }
            }
          }
        }
      },
      data: {
        labels: data.map(row => row.day),
        datasets: [
          {
            label: 'Pages read',
            data: data.map(row => row.reading.reduce((a, b) => a + (b.end - b.start), 0))
          }
        ]
      }
    }
  );
  new Chart(
    document.getElementById('exercise'),
    {
      type: 'bar',
      options: {
        maintainAspectRatio: false,
        plugins: {
          annotation: {
            annotations: {
              line: {
                type: 'line',
                yMin: 180,
                yMax: 180,
              }
            }
          }
        }
      },
      data: {
        labels: data.map(row => row.day),
        datasets: [
          {
            label: 'Minutes of exercise',
            data: data.map(row => row.exercise.reduce((a, b) => a + b.minutes, 0))
          }
        ]
      }
    }
  );
  new Chart(
    document.getElementById('sleep'),
    {
      type: 'bar',
      options: {
        maintainAspectRatio: false,
        plugins: {
          annotation: {
            annotations: {
              line: {
                type: 'line',
                yMin: 3,
                yMax: 3,
              }
            }
          }
        }
      },
      data: {
        labels: data.map(row => row.day),
        datasets: [
          {
            label: 'Hours of sleep',
            data: data.map(row => row.sleep.reduce((a, b) => a + b.duration, 0)),
          }
        ]
      }
    }
  );
</SCRIPT>
