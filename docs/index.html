<STYLE>
  * {
    background-color: rgb(10, 10, 15);
  }
  div {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr 1fr;
    height: 45vh;
  }
  div > div {
    margin: 2%;
  }
</STYLE>

<DIV>
  <DIV>
    <CANVAS id="caffeine"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="books"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="exercise"></CANVAS>
  </DIV>
  <DIV>
    <CANVAS id="sleep"></CANVAS>
  </DIV>
</DIV>

<SCRIPT src="https://cdn.jsdelivr.net/npm/chart.js"></SCRIPT>
<SCRIPT src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></SCRIPT>

<SCRIPT SRC="data.js"></SCRIPT>
<SCRIPT>
  const origin = Date.parse('2023-08-19');
  const ONE_DAY = 86400000;
  const today = (new Date()).getTime();
  let x = origin;
  let full_data = [];
  data.forEach(row => {
    t = Date.parse(row.day);
    while (x < t) {
      full_data.push({day: (new Date(x)).toLocaleDateString()});
      x += ONE_DAY;
    }
    full_data.push(row);
    x += ONE_DAY;
  });
  while (x+ONE_DAY < today) {
    full_data.push({day: (new Date(x)).toLocaleDateString()});
    x += ONE_DAY;
  }
  data = full_data;

  data.forEach(row => {
    if (!("caffeine" in row)) {
      row.caffeine = []
    }
    if (!("reading" in row)) {
      row.reading = []
    }
    if (!("exercise" in row)) {
      row.exercise = []
    }
    if (!("sleep" in row)) {
      row.sleep = []
    }
  });

  data.forEach(row => row.sleep.forEach(x => {
    let [sh, sm] = x.start.split(':');
    let [eh, em] = x.end.split(':');
    x.duration = ((+eh)*60+(+em) - (+sh)*60+(+sm));
    x.duration = x.duration>0 ? x.duration : x.duration+24;
  }))
  
  function makeChart(params) {
    Chart.defaults.color = "rgb(0,200,80)";
    Chart.defaults.font.family = 'Courier New, monospaced'
//    Chart.defaults.font.weight = 'bold'
    Chart.defaults.font.size = 15
    new Chart(
      document.getElementById(params.id),
      {
        type: 'bar',
        options: {
          elements: {
            bar: {
              backgroundColor: 'rgb(0,120,40)',
            },
          },
          clip: false,
          scales: {
            x: {
              grid: {
                display: false,
              },
              ticks: {
                display: false,
              },
              border: {
                display: false,
              },
            },
            y: {
              grid: {
                display: false,
              },
              border: {
                display: false,
              },
            },
          },
          maintainAspectRatio: false,
          plugins: {
            annotation: {
              annotations: {
                line: {
                  type: 'line',
                  yMin: params.goal,
                  yMax: params.goal,
                  borderColor: 'rgb(200, 0, 120)',
                  borderWidth: 5,
                  borderDash: [2],
                }
              }
            }
          }
        },
        data: {
          labels: params.full_data.map(row => row.day),
          datasets: [
            {
              label: params.label,
              data: params.data,
            }
          ]
        }
      }
    );
  }
  const caffeine_params = {
    id: 'caffeine',
    goal: 30,
    full_data: data,
    label: 'caffeine (mg)'.toUpperCase(),
    data: data.map(row => row.caffeine.reduce((a, b) => a + b.amount, 0)),
  }
  makeChart(caffeine_params);
  const reading_params = {
    id: 'books',
    goal: 100,
    full_data: data,
    label: 'books (pages)'.toUpperCase(),
    data: data.map(row => row.reading.reduce((a, b) => a + (b.end - b.start), 0))
  }
  makeChart(reading_params);
  const exercise_params = {
    id: 'exercise',
    goal: 3*60,
    full_data: data,
    label: 'exercise (mins)'.toUpperCase(),
    data: data.map(row => row.exercise.reduce((a, b) => a + b.minutes, 0))
  }
  makeChart(exercise_params);
  const sleep_params = {
    id: 'sleep',
    goal: 9*60,
    full_data: data,
    label: 'sleep (mins)'.toUpperCase(),
    data: data.map(row => row.sleep.reduce((a, b) => a + b.duration, 0)),
  }
  makeChart(sleep_params);
</SCRIPT>
